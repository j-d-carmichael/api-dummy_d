<html>
<head>
  <script type="module">
    import SpeedTest from 'https://cdn.skypack.dev/@cloudflare/speedtest';
  
    const controlEl = document.getElementById('controls');
    const resEl = document.getElementById('result');
    const sumEl = document.getElementById('summary');

    var resultsJson = 'No results yet...'
    
    const engine = new SpeedTest({
      autoStart: false
    });
    let results = {};
    engine.onRunningChange = running => controlEl.textContent = running ? 'Running...' : 'Finished!';
    engine.onResultsChange = ({ type }) => {
      !engine.isFinished && setResult(engine.results.raw, resEl);
      console.log(type);
      results[type] = results[type] || [];
      results[type].push(engine.results.raw);
    };
    engine.onFinish = results => {
      const summary = results.getSummary();
      setResult(summary, sumEl);
      resultsJson = JSON.enscode(summary);
  
      for (const resultsKey in results) {
        if (typeof results[resultsKey] === 'function') {
          console.log(resultsKey, results[resultsKey]());
        }
      }
    };
  
    engine.onError = (e) => console.log(e);
  
    const playButton = document.createElement('button');
    playButton.textContent = 'Start Speed Measurement';
    playButton.onclick = () => engine.play();
    controlEl.appendChild(playButton);
  
    function setResult (obj, wrapper) {
      const resTxt = document.createElement('pre');
      resTxt.textContent = JSON.stringify(obj, null, 2);
      wrapper.textContent = '';
      wrapper.appendChild(resTxt);
    }

    function whatsapp() { 
        window.open(`whatsapp://send?text=${resultsJson}`) 
    } 
    
  </script>
</head>
<body>
  <div id="controls"></div>

  <div>
    <h2>Final results</h2>
    <button onclick="whatsapp()"> Share results to WhatsApp </button>   
    <div id="summary">...</div>
  </div>
  <div>
    <h2>Progress out...</h2>
    <div id="result"></div>
  </div>
</body>
</html>
